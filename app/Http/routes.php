<?php

/*
| Preliminary routes for development
| To be removed or put under middleware control
| for production
*/
Route::get('/welcome', function() {
	return Session::get('Code');
});

/*
|--------------------------------------------------------------------------
| Application Routes
|--------------------------------------------------------------------------
|
| This route group applies the "web" middleware group to every route
| it contains. The "web" middleware group is defined in your HTTP
| kernel and includes session state, CSRF protection, and more.
|
| The route group doesn't apply the "test.date" middleware, therefore
| the current date will be used for every matching request.
*/
Route::group(['middleware' => ['web']], function () {
	if (App::environment("local")) {
		Route::get('/admin_home', 'AdminController@admin_home');
		Route::get('/AdminCodes','AdminController@admin_codes');
		Route::get('/AdminUsers','AdminController@admin_users');
	}

	Route::get('/', 'GateController@enter_system');

	Route::get('/ContactTeam', 'ContactController@contact_team');
	Route::post('/SendMessage', 'ContactController@send_message');

	Route::get('/impressum', function() {
		return view('system.impressum');
	});
	Route::get('/privacy', function() {
		return view('system.privacy');
	});
	Route::get('/about', function() {
		return view('system.about');
	});
	Route::get('/info', function() {
		return view('system.info');
	});

	Route::get('/ResetPassword', 'GateController@reset_password');
	Route::post('/MailForPassword', 'GateController@mail_for_password');

	// Registration routes...
	/* urls: as should be
	Route::post('/register', 'GateController@start_registration');
	Route::get('/registration/welcome', 'GateController@show_welcome');
	Route::get('/registration/agreement', 'GateController@from_welcome');
	Route::get('/registration/form', 'GateController@req_patient_data');
	Route::post('/registration/form', 'GateController@save_patient_data'); */

	/* urls: conform to model (...) */
	Route::post('/StartRegistration', 'GateController@start_registration');
	Route::get('/FromWelcome', 'GateController@from_welcome');
	Route::get('/Accepted', 'GateController@req_patient_data');
	Route::post('/SavePatientData', 'GateController@save_patient_data');

	// Authentication routes...
	Route::get('/Login', 'Auth\AuthController@getLogin');
	Route::post('/Login', 'Auth\AuthController@postLogin');

	Route::get('/Logout', 'Auth\AuthController@logout');

	Route::group(['prefix' => '/password'], function() {
		// Password reset link request routes...
		Route::get('email', 'Auth\PasswordController@getEmail');
		Route::post('email', 'Auth\PasswordController@postEmail');

		// Password reset routes...
		Route::get('reset/{token}', 'Auth\PasswordController@getReset');
		Route::post('reset', 'Auth\PasswordController@postReset');
	});

	Route::get('/AssignmentTemplate','DiaryController@select_assignment');

	if (App::environment("local")) {
		Route::group(['prefix' => '/test'], function() {
			/*
             * The following pages are working on the current date. The test
			 * date is read from the database.
             */
			Route::post('login/{user}', 'TestController@loginAs');
			Route::post('settings', 'TestController@changeSettings');

			Route::post('send-reminders/{option}', 'TestController@sendReminders');
			Route::post('remove-distant-data', 'TestController@clearDistantData');

			/*
			 * The following pages are working with the test date. It is needed to
			 * calculate the patient week or to resolve the current or next
			 * assignment.
			 */
			Route::group(['middleware' => ['test.date']], function() {
				Route::get('', 'TestController@showOverview');

				Route::post('next-date', 'TestController@setRelativeTestDate');
				Route::post('next-date/{patient}', 'TestController@setAssignmentRelatedTestDate');
				Route::post('next-reminder/{patient}', 'TestController@setDateOfCurrentReminder');

				/*
                 * The following routes are working with an info array (generated by the
                 * method InfoModel#to_info()). This array contains calculated values
                 * (like the patient week). Therefore the test middleware should be
                 * applied.
                 */
				Route::group(['prefix' => 'dump-info/{user}'], function() {
					Route::get('', 'TestController@dumpInfo');
					Route::post('save', 'TestController@saveDumpToLogFile');
				});
			});
		});
	}
});

/*
 *  The following routes are working with the test date (if one is specified).
 */
Route::group(['middleware' => ['web', 'auth', 'test.date']], function () {
	Route::get('/Home', 'AuxController@home');

	Route::get('/Diary/{name?}','DiaryController@show');
	Route::get('/CommentedDiary/{name}','DiaryController@commented_diary');
	Route::get('/Profile/{name?}','PatientController@profile');
	Route::post('/SendMail','ContactController@message_to_patients');
	Route::post('/MassAction/mail','ContactController@mail_editor');
	Route::post('/SetSlots', 'PatientListController@set_slots');
	
	// patient profile: routes for post requests
	Route::group(['prefix' => '/patient/{patient}'], function () {
		Route::post('therapist', 'PatientController@save_therapist');
		Route::post('day_of_week', 'PatientController@save_day_of_week');
		Route::post('date_from_clinics', 'PatientController@save_date_from_clinics');
		Route::post('password', 'PatientController@save_password');
		Route::post('personal_information', 'PatientController@save_personal_information');
		Route::get('cancel_intervention', 'PatientController@cancel_intervention');
		Route::post('notes', 'PatientController@save_notes_of_therapist');
	});

	Route::get('/patient_list', 'PatientListController@show');
	Route::any('/patient_list/data', 'PatientListController@anyData')->name('datatables.data');
	
	Route::get('/Assignment/{patient}/{week}','DiaryController@entry');
	Route::post('/SaveAssignment/{patient}/{week}','DiaryController@save_entry');
});
